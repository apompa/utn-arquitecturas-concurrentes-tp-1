<!doctype html>
<html>

<head>
  <title>PROFESOR</title>
  <link rel="stylesheet" href="main.css">
</head>

<body>
  <h1 id="title" class="title">[Profesor] ...</h1>
  <ul id="messages"></ul>

  <script src="socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    (function(){
        var socket = io("/teachers");
        var myself = {};
        var questionsCounter = 1;
        var questionsBeingAnswered =  [];

        var $messages = $("#messages");
        
         var onMessage = function(message) {
            $messages.append($('<li>').text(message.text));
            $("html, body").scrollTop($messages.get(0).scrollHeight);
          };  
          
          socket.on('whoami', function(person) {
            myself = person;
            document.getElementById("title").innerHTML = "[Profesor] " + myself.name;
            document.title = "[Profesor] " + myself.name;
          });

          socket.on('student question', function(question) {
              onMessage(question);
              questionsCounter++;
              console.log(1);
              if (questionsCounter % Math.round(Math.random()*5) === 0) {
                if($.inArray(question.timestamp, questionsBeingAnswered)!=-1){
                    onMessage({text:"Ya se est√° respondiendo la pregunta "+question.text});
                    return;
                }
                var now = Date.now();
                var answer = {
                  teacher: myself,
                  question: question,
                  text: '[' + now + '] "' + question.text + '" - Respuesta de ' + myself.name + ': NO.',
                  timestamp: now
                };
                socket.emit('typing client', {
                  question: question,
                  answer: answer,
                  text: 'Soy ' + myself.name + ' y estoy escribiendo una respuesta a "' + question.text + '"'
                });
              }
          });

          socket.on('teacher answer', function(answer){
            questionsBeingAnswered.pop(answer.question.timestamp)
            console.log(4);
            onMessage(answer);            
          });
          socket.on('typing server', function(typingObj){
            questionsBeingAnswered.push(typingObj.question.timestamp);
            onMessage(typingObj);
            console.log(2);
          });  
          socket.on('finished typing', function(answer){
            console.log(3);
              socket.emit('teacher answer', answer);
          });
        })();
  </script>
</body>

</html>